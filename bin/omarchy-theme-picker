#!/usr/bin/env bash

set -euo pipefail

SCRIPT_NAME="$(basename "$0")"
CONFIG_DIR="$HOME/.config/omarchy"
THEME_DIR="$CONFIG_DIR/theme"
LIGHT_MODE_FILE="$THEME_DIR/light.mode"

# Available themes (matches config.nix)
THEMES=(
    "tokyo-night"
    "kanagawa" 
    "everforest"
    "catppuccin"
    "catppuccin-latte"
    "rose-pine"
    "rose-pine-dawn"
    "rose-pine-moon"
    "nord"
    "gruvbox"
    "gruvbox-light"
)

# Theme descriptions for better UX
declare -A THEME_DESCRIPTIONS=(
    ["tokyo-night"]="Tokyo Night - Dark purple theme inspired by Tokyo's neon lights"
    ["kanagawa"]="Kanagawa - Warm, earthy theme inspired by Japanese art"
    ["everforest"]="Everforest - Comfortable green theme easy on the eyes"
    ["catppuccin"]="Catppuccin - Soothing pastel theme for the high-spirited"
    ["catppuccin-latte"]="Catppuccin Latte - Light variant of Catppuccin"
    ["rose-pine"]="Rose Pine - Soho vibes with natural colors"
    ["rose-pine-dawn"]="Rose Pine Dawn - Light variant with warm tones"
    ["rose-pine-moon"]="Rose Pine Moon - Darker variant with cool tones"
    ["nord"]="Nord - Arctic, north-bluish color palette"
    ["gruvbox"]="Gruvbox - Retro groove color scheme"
    ["gruvbox-light"]="Gruvbox Light - Light variant of the retro groove theme"
)

# Light themes for automatic light mode detection
LIGHT_THEMES=("catppuccin-latte" "rose-pine-dawn" "gruvbox-light")

usage() {
    echo "Usage: $SCRIPT_NAME [THEME_NAME] [--light-mode] [--dark-mode] [--list] [--help]"
    echo ""
    echo "Interactive theme picker for Omarchy configuration"
    echo ""
    echo "Options:"
    echo "  THEME_NAME  Set theme directly (bypasses interactive picker)"
    echo "  --light-mode Enable light mode flag"
    echo "  --dark-mode  Disable light mode flag"
    echo "  --list       List available themes"
    echo "  --help       Show this help message"
    echo ""
    echo "Available themes: ${THEMES[*]}"
}

list_themes() {
    echo "Available Omarchy themes:"
    echo ""
    for theme in "${THEMES[@]}"; do
        local desc="${THEME_DESCRIPTIONS[$theme]:-No description available}"
        local light_indicator=""
        if [[ " ${LIGHT_THEMES[*]} " =~ " ${theme} " ]]; then
            light_indicator=" [LIGHT]"
        fi
        printf "  %-20s - %s%s\n" "$theme" "$desc" "$light_indicator"
    done
}

set_theme() {
    local theme="$1"
    
    # Validate theme
    if [[ ! " ${THEMES[*]} " =~ " ${theme} " ]]; then
        echo "âŒ Invalid theme: $theme"
        echo "Available themes: ${THEMES[*]}"
        exit 1
    fi

    echo "Setting theme to: $theme"
    
    # This would normally require rebuilding the NixOS configuration
    # For now, we'll create a theme preference file that could be used
    # by configuration management
    mkdir -p "$CONFIG_DIR"
    echo "$theme" > "$CONFIG_DIR/selected_theme"
    
    echo "âœ… Theme preference saved!"
    echo ""
    echo "To apply the theme, you'll need to:"
    echo "1. Update your Omarchy configuration with: omarchy.theme = \"$theme\";"
    echo "2. Rebuild your system with: nixos-rebuild switch --flake ."
    echo ""
    
    # If it's a light theme, suggest enabling light mode
    if [[ " ${LIGHT_THEMES[*]} " =~ " ${theme} " ]]; then
        echo "ðŸ’¡ This is a light theme. Consider running: $SCRIPT_NAME --light-mode"
    fi
}

toggle_light_mode() {
    local enable="$1"
    
    mkdir -p "$THEME_DIR"
    
    if [[ "$enable" == "true" ]]; then
        touch "$LIGHT_MODE_FILE"
        echo "âœ… Light mode enabled"
        echo "System will use light theme variants when available"
    else
        rm -f "$LIGHT_MODE_FILE"
        echo "âœ… Dark mode enabled"  
        echo "System will use standard dark themes"
    fi
}

interactive_picker() {
    echo "ðŸŽ¨ Omarchy Theme Picker"
    echo "======================="
    echo ""
    
    # Create a temporary file with theme options
    local theme_list_file
    theme_list_file=$(mktemp)
    
    for theme in "${THEMES[@]}"; do
        local desc="${THEME_DESCRIPTIONS[$theme]:-No description}"
        local light_indicator=""
        if [[ " ${LIGHT_THEMES[*]} " =~ " ${theme} " ]]; then
            light_indicator=" [LIGHT]"
        fi
        echo "$theme - $desc$light_indicator" >> "$theme_list_file"
    done
    
    # Use walker if available, otherwise fall back to basic selection
    if command -v walker >/dev/null 2>&1; then
        echo "Select a theme using Walker:"
        local selection
        selection=$(walker --dmenu < "$theme_list_file" || echo "")
        
        if [[ -n "$selection" ]]; then
            local theme
            theme=$(echo "$selection" | cut -d' ' -f1)
            set_theme "$theme"
        else
            echo "No theme selected"
        fi
    else
        echo "Walker not available, using basic selection:"
        echo ""
        select theme_line in $(cat "$theme_list_file"); do
            if [[ -n "$theme_line" ]]; then
                local theme
                theme=$(echo "$theme_line" | cut -d' ' -f1)
                set_theme "$theme"
                break
            fi
        done
    fi
    
    rm -f "$theme_list_file"
}

main() {
    case "${1:-}" in
        --light-mode)
            toggle_light_mode "true"
            ;;
        --dark-mode)
            toggle_light_mode "false"
            ;;
        --list)
            list_themes
            ;;
        --help)
            usage
            ;;
        "")
            interactive_picker
            ;;
        *)
            # Assume it's a theme name
            if [[ "$1" =~ ^-- ]]; then
                echo "Unknown option: $1"
                usage
                exit 1
            else
                set_theme "$1"
            fi
            ;;
    esac
}

main "$@"